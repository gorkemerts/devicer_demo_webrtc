<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>wbrtc demo v1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .app-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 30px;
    }

    .phone-container {
      width: 420px;
      height: 800px;
      background: #1a1a1a;
      border-radius: 35px;
      padding: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      position: relative;
      overflow: hidden;
    }

    .phone-container::before {
      content: '';
      position: absolute;
      top: 15px;
      left: 50%;
      transform: translateX(-50%);
      width: 120px;
      height: 5px;
      background: #333;
      border-radius: 3px;
    }

    .screen {
      width: 100%;
      height: 100%;
      background: #000;
      border-radius: 25px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
    }

    .status-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #fff;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 20px;
      padding: 0 5px;
    }

    .time {
      font-size: 16px;
    }

    .battery {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .app-header {
      text-align: center;
      margin-bottom: 20px;
    }

    .app-title {
      color: #fff;
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .connection-status {
      color: #666;
      font-size: 12px;
      padding: 5px 12px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      display: inline-block;
    }

    .connection-status.connected {
      color: #4ade80;
      background: rgba(74, 222, 128, 0.2);
    }

    .video-container {
      flex: 1;
      margin: 10px 0;
      position: relative;
      border-radius: 20px;
      overflow: hidden;
      background: #111;
    }

    #videoCanvas {
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: 20px;
      background: #000;
    }

    .video-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 16px;
      text-align: center;
      border-radius: 0px;
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 10;
    }

    .video-overlay.show {
      opacity: 1;
      z-index: 10;
    }

    .controls {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
    }

    .control-btn {
      flex: 1;
      height: 50px;
      border: none;
      border-radius: 25px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .connect-btn {
      background: linear-gradient(45deg, #4ade80, #22c55e);
      color: white;
    }

    .connect-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(74, 222, 128, 0.4);
    }

    .connect-btn:disabled {
      background: #374151;
      color: #6b7280;
      transform: none;
      box-shadow: none;
    }

    .chat-container {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 20px;
      padding: 12px;
      backdrop-filter: blur(10px);
      margin-top: auto;
    }

    .message-input {
      width: 100%;
      height: 45px;
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 22px;
      padding: 0 20px;
      color: #fff;
      font-size: 16px;
      outline: none;
      margin-bottom: 10px;
    }

    .message-input::placeholder {
      color: #888;
    }

    .message-input:focus {
      border-color: #4ade80;
      box-shadow: 0 0 0 2px rgba(74, 222, 128, 0.2);
    }

    .send-btn {
      width: 100%;
      height: 45px;
      background: linear-gradient(45deg, #3b82f6, #1d4ed8);
      border: none;
      border-radius: 22px;
      color: white;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .send-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4);
    }

    .send-btn:disabled {
      background: #374151;
      color: #6b7280;
      transform: none;
      box-shadow: none;
    }

    .floating-particles {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
      overflow: hidden;
    }

    .particle {
      position: absolute;
      width: 3px;
      height: 3px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      animation: float 4s infinite ease-in-out;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0; }
      50% { transform: translateY(-20px) rotate(180deg); opacity: 1; }
    }

    .pulse {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    @media (max-width: 500px) {
      .phone-container, .external-controls {
        width: 100%;
      }
      
       .phone-container {
      width: 432px;
      height: 936px;
      background: #1a1a1a;
      border-radius: 35px;
      padding: 10px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      position: relative;
      overflow: hidden;
    }
      
      .screen {
        border-radius: 15px;
      }
    }
  </style>
</head>
<body>
  <div class="app-wrapper">
    <div class="phone-container">
      <div class="floating-particles"></div>
      <div class="screen">
        <div class="status-bar">
          <div class="time" id="currentTime">15:30</div>
          <div class="battery">
            <span>📶</span>
            <span>🔋</span>
            <span>89%</span>
          </div>
        </div>

        <div class="app-header">
          <div class="app-title">WebRTC Stream</div>
          <div class="connection-status" id="connectionStatus">Bağlantı Bekleniyor</div>
        </div>

        <div class="video-container">
          <canvas id="videoCanvas"></canvas>
          <div class="video-overlay" id="videoOverlay">
            <div>📹 Video akışı için bağlanın</div>
          </div>
        </div>
      </div>
    </div>

    <div class="external-controls">
      <div class="controls">
        <button class="control-btn connect-btn" id="connectBtn">
          <span>🔗 Bağlan</span>
        </button>
      </div>

      <div class="chat-container">
        <input id="msgInput" class="message-input" placeholder="💬 Mesaj yazın (/files, /photos, /downloads)">
        <button id="sendBtn" class="send-btn" disabled>
          <span>📤 Gönder</span>
        </button>
      </div>
    </div>
  </div>
  <script>
    let ws, pc, dc;
    const canvas = document.getElementById('videoCanvas');
    const ctx = canvas.getContext('2d');
    
    // Canvas'ı bir kereye mahsus boyutlandır
    function initCanvas() {
      const container = canvas.parentElement;
      const containerRect = container.getBoundingClientRect();
      
      // Canvas'ın CSS boyutunu değil, gerçek çizim yüzeyini ayarla
      canvas.width = containerRect.width;
      canvas.height = containerRect.height;
      
      // Başlangıçta ekranı siyah yap
      ctx.fillStyle = '#000';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
    }
    
    // Sayfa yüklendiğinde ve pencere yeniden boyutlandırıldığında canvas'ı ayarla
    window.addEventListener('load', initCanvas);
    window.addEventListener('resize', initCanvas);

    // ... (Diğer UI elementleri ve fonksiyonlar aynı kalacak) ...
    const connectBtn = document.getElementById('connectBtn');
    const sendBtn = document.getElementById('sendBtn');
    const msgInput = document.getElementById('msgInput');
    const connectionStatus = document.getElementById('connectionStatus');
    const videoOverlay = document.getElementById('videoOverlay');

    // ... (handleDataMessage, displayFileList, showNotification, vb. fonksiyonlar aynı) ...
    // --- BU ARADAKİ FONKSİYONLARINIZI DEĞİŞTİRMEYİN ---
    function handleDataMessage(data) {
      console.log("Telefon verisi alındı:", data.type);
      
      switch (data.type) {
        case 'phone_info':
          console.log("📱 Telefon Bilgileri:", data.data);
          updateConnectionStatus(`📱 ${data.data.brand} ${data.data.model}`, true);
          break;
          
        case 'file_list':
          console.log("📁 Dosya Listesi:", data.files);
          displayFileList(data.files);
          break;
          
        case 'file_pulled':
          if (data.success) {
            console.log("✅ Dosya başarıyla çekildi:", data.localPath);
            showNotification("✅ Dosya indirildi: " + data.localPath.split('/').pop());
          }
          break;
          
        case 'app_data':
          console.log("📱 Uygulama Verisi:", data.data);
          break;
          
        case 'bulk_transfer_complete':
          console.log("📦 Toplu transfer tamamlandı:", data.results);
          const successCount = data.results.filter(r => r.success).length;
          showNotification(`✅ ${successCount}/${data.results.length} dosya indirildi`);
          break;
          
        case 'error':
          console.error("❌ Sunucu hatası:", data.message);
          showNotification("❌ Hata: " + data.message);
          break;
      }
    }
    function displayFileList(files) {
      console.log("📁 Telefon Dosyaları:");
      files.forEach(file => {
        if (file.trim()) console.log("  ", file);
      });
      showNotification(`📂 ${files.length} dosya listelendi (konsola bakın)`);
    }
    function showNotification(message) {
      const overlay = document.getElementById('videoOverlay');
      overlay.innerHTML = `<div>${message}</div>`;
      overlay.classList.add('show');
      setTimeout(() => {
        overlay.classList.remove('show');
      }, 3000);
    }
    function sendDataCommand(command) {
      if (dc && dc.readyState === 'open') {
        dc.send(JSON.stringify(command));
      } else {
        console.log("❌ DataChannel henüz açık değil!");
        showNotification("❌ Önce bağlantı kurun");
      }
    }
    function handleSpecialCommands(command) {
      const cmd = command.toLowerCase();
      
      if (cmd === '/files' || cmd === '/ls') {
        sendDataCommand({ type: 'list_files', directory: '/sdcard/' });
        showNotification("📂 Dosyalar listeleniyor...");
      }
      else if (cmd === '/photos') {
        sendDataCommand({ type: 'list_files', directory: '/sdcard/DCIM/Camera/' });
        showNotification("📸 Fotoğraflar listeleniyor...");
      }
      else if (cmd === '/downloads') {
        sendDataCommand({ type: 'list_files', directory: '/sdcard/Download/' });
        showNotification("⬇️ İndirilenler listeleniyor...");
      }
      else if (cmd.startsWith('/pull ')) {
        const filePath = cmd.substring(6);
        const fileName = filePath.split('/').pop();
        sendDataCommand({ 
          type: 'pull_file', 
          remotePath: filePath, 
          localPath: `./downloads/${fileName}` 
        });
        showNotification(`⬇️ Dosya indiriliyor: ${fileName}`);
      }
      else if (cmd === '/info') {
        showNotification("📱 Telefon bilgileri alınıyor...");
      }
      else if (cmd === '/help') {
        showNotification("📋 Komutlar: /files, /photos, /downloads, /pull [yol], /info");
      }
      else {
        showNotification("❓ Bilinmeyen komut. /help yazın");
      }
    }
    window.listFiles = (dir = '/sdcard/') => { sendDataCommand({ type: 'list_files', directory: dir }); };
    window.pullFile = (remotePath, localPath) => { sendDataCommand({ type: 'pull_file', remotePath, localPath }); };
    window.pullPhotos = () => { sendDataCommand({ type: 'pull_multiple', fileList: ['/sdcard/DCIM/Camera/'], localDir: './photos' }); };
    window.getAppData = (packageName) => { sendDataCommand({ type: 'get_app_data', packageName }); };
    function updateTime() {
      const now = new Date();
      document.getElementById('currentTime').textContent = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
    }
    updateTime();
    setInterval(updateTime, 1000);
    function createParticles() {
      const container = document.querySelector('.floating-particles');
      for (let i = 0; i < 15; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.style.left = Math.random() * 100 + '%';
        particle.style.animationDelay = Math.random() * 4 + 's';
        particle.style.animationDuration = (3 + Math.random() * 2) + 's';
        container.appendChild(particle);
      }
    }
    createParticles();
    function updateConnectionStatus(status, isConnected = false) {
      connectionStatus.textContent = status;
      connectionStatus.className = 'connection-status' + (isConnected ? ' connected' : '');
    }
    // --- BU ARADAKİ FONKSİYONLARINIZI DEĞİŞTİRMEYİN ---


    ws = new WebSocket('ws://localhost:3000');
    // ... (ws.onopen, ws.onerror aynı) ...
    ws.onopen = () => {
      console.log("Signalizasyon sunucusuna bağlandı");
      updateConnectionStatus("Sunucuya Bağlandı", true);
      ws.send(JSON.stringify({ type: 'client_awake' }));
    };

    ws.onerror = () => {
      updateConnectionStatus("Bağlantı Hatası");
    };

    connectBtn.onclick = () => {
      connectBtn.disabled = true;
      connectBtn.innerHTML = '<span>🔄 Bağlanıyor...</span>';
      connectBtn.classList.add('pulse');
      
      ws.send(JSON.stringify({ type: 'client_offers' }));

      ws.onmessage = async (event) => {
        const data = JSON.parse(event.data);
        // console.log(data); // Konsolu kirletmemek için kapatılabilir
        if (data.type === 'stream_offer') {
          pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });

          pc.ondatachannel = (event) => {
            dc = event.channel;
            dc.onopen = () => {
              console.log("DataChannel açıldı!");
              updateConnectionStatus("🎥 Canlı Yayın", true);
              sendBtn.disabled = false;
              connectBtn.innerHTML = '<span>✅ Bağlandı</span>';
              connectBtn.classList.remove('pulse');
              videoOverlay.classList.remove('show');
            };

            let imageChunks = [];
            const DELIMITER = '|||JPEG_END|||';

            dc.onmessage = (msg) => {
              if (typeof msg.data === 'string' && msg.data === DELIMITER) {
                if (imageChunks.length > 0) {
                  const imageBlob = new Blob(imageChunks, { type: 'image/jpeg' });
                  const url = URL.createObjectURL(imageBlob);
                  const img = new Image();

                  // --- YENİ VE PERFORMANSLI ÇİZİM MANTIĞI ---
                  img.onload = () => {
                    const canvasWidth = canvas.width;
                    const canvasHeight = canvas.height;
                    const imgRatio = img.width / img.height;
                    const canvasRatio = canvasWidth / canvasHeight;

                    let drawWidth = canvasWidth;
                    let drawHeight = canvasHeight;
                    let x = 0;
                    let y = 0;

                    // Görüntü, kanvastan daha genişse (veya daha az yüksekse),
                    // yüksekliği kanvasa sığdır ve genişliği ayarla
                    if (imgRatio > canvasRatio) {
                        drawHeight = canvasWidth / imgRatio;
                        y = (canvasHeight - drawHeight) / 2; // Dikeyde ortala
                    } else {
                    // Görüntü, kanvastan daha darsa (veya daha yüksekse),
                    // genişliği kanvasa sığdır ve yüksekliği ayarla
                        drawWidth = canvasHeight * imgRatio;
                        x = (canvasWidth - drawWidth) / 2; // Yatayda ortala
                    }
                    
                    // Önceki kareyi temizle ve siyah bir arka plan çiz
                    ctx.fillStyle = '#000';
                    ctx.fillRect(0, 0, canvasWidth, canvasHeight);

                    // Görüntüyü hesaplanan boyut ve pozisyonda kanvasa çiz
                    ctx.drawImage(img, x, y, drawWidth, drawHeight);

                    URL.revokeObjectURL(url);
                  };

                  img.onerror = () => {
                    console.error("JPEG decode hatası. Birleştirilen veri bozuk olabilir.");
                    URL.revokeObjectURL(url);
                  };
                  img.src = url;
                }
                imageChunks = []; // Bir sonraki kare için sıfırla
              } else if (typeof msg.data === 'string') {
                try {
                  const jsonData = JSON.parse(msg.data);
                  handleDataMessage(jsonData);
                } catch (e) {
                  console.log("Alınan metin mesajı:", msg.data);
                }
              } else {
                imageChunks.push(msg.data);
              }
            };

            dc.onclose = () => {
              updateConnectionStatus("Bağlantı Kesildi");
              sendBtn.disabled = true;
              connectBtn.disabled = false;
              connectBtn.innerHTML = '<span>🔗 Tekrar Bağlan</span>';
              videoOverlay.classList.add('show');
            };
          };

          // ... (pc.onicecandidate, setRemoteDescription, createAnswer vb. aynı) ...
           pc.onicecandidate = (e) => {
            if (e.candidate) {
              ws.send(JSON.stringify({ type: 'candidate', candidate: e.candidate }));
            }
          };
          await pc.setRemoteDescription(data.offer);
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          ws.send(JSON.stringify({ type: 'answer', answer }));
        } 
        else if (data.type === 'streamer_candidate') {
          if (pc) await pc.addIceCandidate(data.candidate);
        }
      };
    };

    // ... (Mesaj gönderme ve diğer UI mantığı aynı kalacak) ...
    msgInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !sendBtn.disabled) {
        sendMessage();
      }
    });

    sendBtn.onclick = sendMessage;

    function sendMessage() {
      const msg = msgInput.value.trim();
      if (msg && dc && dc.readyState === 'open') {
        if (msg.startsWith('/')) {
          handleSpecialCommands(msg);
        } else {
          dc.send(msg);
          console.log("Gönderilen mesaj:", msg);
        }
        msgInput.value = '';
        sendBtn.style.transform = 'scale(0.95)';
        setTimeout(() => {
          sendBtn.style.transform = 'scale(1)';
        }, 150);
      } else if (!dc || dc.readyState !== 'open') {
        console.log("DataChannel henüz açık değil!");
        updateConnectionStatus("Önce bağlantı kurun");
      }
    }
    videoOverlay.classList.add('show');
    console.log(`
📱 ADB Data Transfer Komutları:
• listFiles('/sdcard/Pictures/') - Dosya listele
• pullFile('/sdcard/Download/foto.jpg', './foto.jpg') - Dosya çek
• pullPhotos() - Tüm fotoğrafları çek
• getAppData('com.whatsapp') - Uygulama verisi
    `);
  </script>
    
</body>
</html>