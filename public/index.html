<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>wbrtc demo v1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .app-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 30px;
    }

    .phone-container {
      width: 420px;
      height: 800px;
      background: #1a1a1a;
      border-radius: 35px;
      padding: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      position: relative;
      overflow: hidden;
    }

    .phone-container::before {
      content: '';
      position: absolute;
      top: 15px;
      left: 50%;
      transform: translateX(-50%);
      width: 120px;
      height: 5px;
      background: #333;
      border-radius: 3px;
    }

    .screen {
      width: 100%;
      height: 100%;
      background: #000;
      border-radius: 25px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
    }

    .status-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #fff;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 20px;
      padding: 0 5px;
    }

    .time {
      font-size: 16px;
    }

    .battery {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .app-header {
      text-align: center;
      margin-bottom: 20px;
    }

    .app-title {
      color: #fff;
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .connection-status {
      color: #666;
      font-size: 12px;
      padding: 5px 12px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      display: inline-block;
    }

    .connection-status.connected {
      color: #4ade80;
      background: rgba(74, 222, 128, 0.2);
    }

    .video-container {
      flex: 1;
      margin: 10px 0;
      position: relative;
      border-radius: 20px;
      overflow: hidden;
      background: #111;
    }

    #videoCanvas {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 20px;
    }

    .video-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 16px;
      border-radius: 0px;
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 10;
    }

    .video-overlay.show {
      opacity: 1;
      z-index: 10;
    }

    .controls {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
    }

    .control-btn {
      flex: 1;
      height: 50px;
      border: none;
      border-radius: 25px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .connect-btn {
      background: linear-gradient(45deg, #4ade80, #22c55e);
      color: white;
    }

    .connect-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(74, 222, 128, 0.4);
    }

    .connect-btn:disabled {
      background: #374151;
      color: #6b7280;
      transform: none;
      box-shadow: none;
    }

    .chat-container {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 20px;
      padding: 12px;
      backdrop-filter: blur(10px);
      margin-top: auto;
    }

    .message-input {
      width: 100%;
      height: 45px;
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 22px;
      padding: 0 20px;
      color: #fff;
      font-size: 16px;
      outline: none;
      margin-bottom: 10px;
    }

    .message-input::placeholder {
      color: #888;
    }

    .message-input:focus {
      border-color: #4ade80;
      box-shadow: 0 0 0 2px rgba(74, 222, 128, 0.2);
    }

    .send-btn {
      width: 100%;
      height: 45px;
      background: linear-gradient(45deg, #3b82f6, #1d4ed8);
      border: none;
      border-radius: 22px;
      color: white;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .send-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4);
    }

    .send-btn:disabled {
      background: #374151;
      color: #6b7280;
      transform: none;
      box-shadow: none;
    }

    .floating-particles {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
      overflow: hidden;
    }

    .particle {
      position: absolute;
      width: 3px;
      height: 3px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      animation: float 4s infinite ease-in-out;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0; }
      50% { transform: translateY(-20px) rotate(180deg); opacity: 1; }
    }

    .pulse {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    @media (max-width: 500px) {
      .phone-container, .external-controls {
        width: 100%;
      }
      
       .phone-container {
      width: 432px;
      height: 936px;
      background: #1a1a1a;
      border-radius: 35px;
      padding: 10px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      position: relative;
      overflow: hidden;
    }
      
      .screen {
        border-radius: 15px;
      }
    }
  </style>
</head>
<body>
  <div class="app-wrapper">
    <div class="phone-container">
      <div class="floating-particles"></div>
      <div class="screen">
        <div class="status-bar">
          <div class="time" id="currentTime">15:30</div>
          <div class="battery">
            <span>ðŸ“¶</span>
            <span>ðŸ”‹</span>
            <span>89%</span>
          </div>
        </div>

        <div class="app-header">
          <div class="app-title">WebRTC Stream</div>
          <div class="connection-status" id="connectionStatus">BaÄŸlantÄ± Bekleniyor</div>
        </div>

        <div class="video-container">
          <canvas id="videoCanvas" width="1080" height="2400"></canvas>
          <div class="video-overlay" id="videoOverlay">
            <div>ðŸ“¹ Video akÄ±ÅŸÄ± iÃ§in baÄŸlanÄ±n</div>
          </div>
        </div>
      </div>
    </div>

    <div class="external-controls">
      <div class="controls">
        <button class="control-btn connect-btn" id="connectBtn">
          <span>ðŸ”— BaÄŸlan</span>
        </button>
      </div>

      <div class="chat-container">
        <input id="msgInput" class="message-input" placeholder="ðŸ’¬ Mesaj yazÄ±n...">
        <button id="sendBtn" class="send-btn" disabled>
          <span>ðŸ“¤ GÃ¶nder</span>
        </button>
      </div>
    </div>
  </div>

  <script>
    let ws, pc, dc;
    const canvas = document.getElementById('videoCanvas');
    const ctx = canvas.getContext('2d');
    let img = new Image();

    // UI elementleri
    const connectBtn = document.getElementById('connectBtn');
    const sendBtn = document.getElementById('sendBtn');
    const msgInput = document.getElementById('msgInput');
    const connectionStatus = document.getElementById('connectionStatus');
    const videoOverlay = document.getElementById('videoOverlay');

    // Saat gÃ¼ncelleme
    function updateTime() {
      const now = new Date();
      document.getElementById('currentTime').textContent = 
        now.getHours().toString().padStart(2, '0') + ':' + 
        now.getMinutes().toString().padStart(2, '0');
    }
    updateTime();
    setInterval(updateTime, 1000);

    // Floating particles oluÅŸtur
    function createParticles() {
      const container = document.querySelector('.floating-particles');
      for (let i = 0; i < 15; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.style.left = Math.random() * 100 + '%';
        particle.style.animationDelay = Math.random() * 4 + 's';
        particle.style.animationDuration = (3 + Math.random() * 2) + 's';
        container.appendChild(particle);
      }
    }
    createParticles();

    // BaÄŸlantÄ± durumu gÃ¼ncelleme
    function updateConnectionStatus(status, isConnected = false) {
      connectionStatus.textContent = status;
      connectionStatus.className = 'connection-status' + (isConnected ? ' connected' : '');
    }

    ws = new WebSocket('ws://localhost:3000');
    ws.onopen = () => {
      console.log("Signalizasyon sunucusuna baÄŸlandÄ±");
      updateConnectionStatus("Sunucuya BaÄŸlandÄ±", true);
      ws.send(JSON.stringify({ type: 'client_awake' }));
    };

    ws.onerror = () => {
      updateConnectionStatus("BaÄŸlantÄ± HatasÄ±");
    };

    connectBtn.onclick = () => {
      connectBtn.disabled = true;
      connectBtn.innerHTML = '<span>ðŸ”„ BaÄŸlanÄ±yor...</span>';
      connectBtn.classList.add('pulse');
      
      ws.send(JSON.stringify({ type: 'client_offers' }));

      ws.onmessage = async (event) => {
        const data = JSON.parse(event.data);
        console.log(data); 
        if (data.type === 'stream_offer') {
          pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });

          pc.ondatachannel = (event) => {
            dc = event.channel;
            dc.onopen = () => {
              console.log("DataChannel aÃ§Ä±ldÄ±!");
              updateConnectionStatus("ðŸŽ¥ CanlÄ± YayÄ±n", true);
              sendBtn.disabled = false;
              connectBtn.innerHTML = '<span>âœ… BaÄŸlandÄ±</span>';
              connectBtn.classList.remove('pulse');
              videoOverlay.classList.remove('show');
            };

            dc.onmessage = (msg) => {
              console.log(msg); 
              const blob = new Blob([msg.data], { type: 'image/jpeg' });
              const url = URL.createObjectURL(blob);

              const img = new Image();
              img.onload = () => {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                URL.revokeObjectURL(url);
              };
              img.src = url;
            };

            dc.onclose = () => {
              updateConnectionStatus("BaÄŸlantÄ± Kesildi");
              sendBtn.disabled = true;
              connectBtn.disabled = false;
              connectBtn.innerHTML = '<span>ðŸ”— Tekrar BaÄŸlan</span>';
              videoOverlay.classList.add('show');
            };
          };

          pc.onicecandidate = (e) => {
            if (e.candidate) {
              ws.send(JSON.stringify({ type: 'candidate', candidate: e.candidate }));
            }
          };

          await pc.setRemoteDescription(data.offer);
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          ws.send(JSON.stringify({ type: 'answer', answer }));
        } 
        else if (data.type === 'streamer_candidate') {
          await pc.addIceCandidate(data.candidate);
        }
      };
    };

    // Enter tuÅŸu ile mesaj gÃ¶nderme
    msgInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !sendBtn.disabled) {
        sendMessage();
      }
    });

    sendBtn.onclick = sendMessage;

    function sendMessage() {
      const msg = msgInput.value.trim();
      if (msg && dc && dc.readyState === 'open') {
        dc.send(msg);
        console.log("GÃ¶nderilen mesaj:", msg);
        msgInput.value = '';
        
        // GÃ¶nderim animasyonu
        sendBtn.style.transform = 'scale(0.95)';
        setTimeout(() => {
          sendBtn.style.transform = 'scale(1)';
        }, 150);
      } else if (!dc || dc.readyState !== 'open') {
        console.log("DataChannel henÃ¼z aÃ§Ä±k deÄŸil!");
        updateConnectionStatus("Ã–nce baÄŸlantÄ± kurun");
      }
    }

    // Video overlay baÅŸlangÄ±Ã§ta gÃ¶ster
    videoOverlay.classList.add('show');
  </script>
</body>
</html>