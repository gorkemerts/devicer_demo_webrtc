<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>DataChannel Video + Log + Chat Demo</title>
</head>
<body>
  <h1>Node.js → Browser DataChannel Video + Chat Demo</h1>

  <button id="connectBtn">Bağlan</button>
  <br><br>

  <canvas id="videoCanvas" width="640" height="360" style="border:1px solid black;"></canvas>
  <br><br>

  <input id="msgInput" placeholder="Mesaj yazın">
  <button id="sendBtn">Gönder</button>

  <script>
    let ws, pc, dc;
    const canvas = document.getElementById('videoCanvas');
    const ctx = canvas.getContext('2d');
    let img = new Image();

    ws = new WebSocket('ws://localhost:3000');
    ws.onopen = () => {
      console.log("Signalizasyon sunucusuna bağlandı");
      ws.send(JSON.stringify({ type: 'client_awake' }));
    };

    document.getElementById('connectBtn').onclick = () => {
      ws.send(JSON.stringify({ type: 'client_offers' }));

      ws.onmessage = async (event) => {
        const data = JSON.parse(event.data);

        if (data.type === 'stream_offer') {
          pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });

          pc.ondatachannel = (event) => {
            dc = event.channel;
            dc.onopen = () => console.log("DataChannel açıldı!");

            // Gelen frame'leri canvas'a çiz ve logla
            dc.onmessage = (msg) => {
              console.log("Frame geldi");

              const blob = new Blob([msg.data], { type: 'image/jpeg' });
              const url = URL.createObjectURL(blob);
              img.onload = () => {
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                URL.revokeObjectURL(url);
              };
              img.src = url;
            };
          };

          pc.onicecandidate = (e) => {
            if (e.candidate) {
              ws.send(JSON.stringify({ type: 'candidate', candidate: e.candidate }));
            }
          };

          await pc.setRemoteDescription(data.offer);
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          ws.send(JSON.stringify({ type: 'answer', answer }));
        } 
        else if (data.type === 'streamer_candidate') {
          await pc.addIceCandidate(data.candidate);
        }
      };
    };

    // Mesaj gönderme
    document.getElementById('sendBtn').onclick = () => {
      const msg = document.getElementById('msgInput').value;
      if (dc && dc.readyState === 'open') {
        dc.send(msg);
        console.log("Gönderilen mesaj:", msg);
      } else {
        console.log("DataChannel henüz açık değil!");
      }
    };
  </script>
</body>
</html>
